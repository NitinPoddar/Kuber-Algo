{% extends "core/base.html" %}
{% block content %}
<section class="section">
  <div class="container">
    <h2 class="title is-4">Profile</h2>

    <!-- Email -->
    <div class="box">
      <div class="level">
        <div class="level-left">
          <div>
            <p class="heading">Email</p>
            <p class="title is-6">{{ user.email }}</p>
            {% if user.is_email_verified %}<span class="tag is-success is-light">Verified</span>{% else %}<span class="tag is-warning is-light">Unverified</span>{% endif %}
          </div>
        </div>
        <div class="level-right">
          <button class="button is-light" onclick="openChange('email')">Change</button>
        </div>
      </div>
      <div id="change-email" class="mt-3" style="display:none;">
        <div class="field has-addons">
          <div class="control is-expanded">
            <input id="new_email" class="input" type="email" placeholder="New email">
          </div>
          <div class="control">
            <button class="button is-link" onclick="startChange('email')">Send code</button>
          </div>
        </div>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input id="email_code" class="input" type="text" maxlength="6" placeholder="Enter email code">
          </div>
          <div class="control">
            <button class="button" onclick="verifyChange('email')">Verify</button>
          </div>
        </div>
        <p id="email_msg" class="help"></p>
      </div>
    </div>

    <!-- Phone -->
    <div class="box">
      <div class="level">
        <div class="level-left">
          <div>
            <p class="heading">Mobile</p>
            <p class="title is-6">{{ user.phone }}</p>
            {% if user.is_phone_verified %}<span class="tag is-success is-light">Verified</span>{% else %}<span class="tag is-warning is-light">Unverified</span>{% endif %}
          </div>
        </div>
        <div class="level-right">
          <button class="button is-light" onclick="openChange('phone')">Change</button>
        </div>
      </div>
      <div id="change-phone" class="mt-3" style="display:none;">
        <div class="field has-addons">
          <div class="control is-expanded">
            <input id="new_phone" class="input" type="text" placeholder="New phone">
          </div>
          <div class="control">
            <button class="button is-link" onclick="startChange('phone')">Send code</button>
          </div>
        </div>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input id="phone_code" class="input" type="text" maxlength="6" placeholder="Enter phone code">
          </div>
          <div class="control">
            <button class="button" onclick="verifyChange('phone')">Verify</button>
          </div>
        </div>
        <p id="phone_msg" class="help"></p>
      </div>
    </div>

    <!-- Password -->
    <div class="box">
      <p class="heading">Password</p>
      <div class="buttons">
        <button class="button is-link is-light" onclick="togglePwdSection('pwd-current')">Change via current password</button>
        <button class="button is-link is-light" onclick="togglePwdSection('pwd-otp')">Change via OTP</button>
      </div>

      <div id="pwd-current" class="mt-3" style="display:none;">
        <div class="field">
          <label class="label">Current password</label>
          <div class="password-wrapper">
            <input id="cur_pwd" class="input" type="password" autocomplete="current-password">
            <span class="toggle-eye" data-target="cur_pwd"><i class="fas fa-eye"></i></span>
          </div>
        </div>
        <div class="field">
          <label class="label">New password</label>
          <div class="password-wrapper">
            <input id="new_pwd" class="input" type="password" autocomplete="new-password">
            <span class="toggle-eye" data-target="new_pwd"><i class="fas fa-eye"></i></span>
          </div>
        </div>
        <div class="field">
          <label class="label">Confirm new password</label>
          <div class="password-wrapper">
            <input id="new_pwd2" class="input" type="password" autocomplete="new-password">
            <span class="toggle-eye" data-target="new_pwd2"><i class="fas fa-eye"></i></span>
          </div>
        </div>
        <button class="button is-link" onclick="savePwdCurrent()">Update Password</button>
        <p id="pwd_current_msg" class="help"></p>
      </div>

      <div id="pwd-otp" class="mt-3" style="display:none;">
        <div class="field">
          <button class="button is-link is-light" onclick="startPwdOtp()">Send OTP codes</button>
        </div>
        <div class="field">
          <label class="label">Email code</label>
          <input id="pwd_email_code" class="input" type="text" maxlength="6">
        </div>
        <div class="field">
          <label class="label">Phone code</label>
          <input id="pwd_phone_code" class="input" type="text" maxlength="6">
        </div>
        <div class="field">
          <label class="label">New password</label>
          <div class="password-wrapper">
            <input id="otp_new_pwd" class="input" type="password" autocomplete="new-password">
            <span class="toggle-eye" data-target="otp_new_pwd"><i class="fas fa-eye"></i></span>
          </div>
        </div>
        <div class="field">
          <label class="label">Confirm new password</label>
          <div class="password-wrapper">
            <input id="otp_new_pwd2" class="input" type="password" autocomplete="new-password">
            <span class="toggle-eye" data-target="otp_new_pwd2"><i class="fas fa-eye"></i></span>
          </div>
        </div>
        <button class="button is-link" onclick="savePwdOtp()">Update Password</button>
        <p id="pwd_otp_msg" class="help"></p>
      </div>
    </div>

    <!-- Danger zone -->
    <div class="box">
      <p class="title is-6 has-text-danger">Delete account</p>
      <p class="mb-3">This action is irreversible.</p>
      <div class="buttons">
        <button class="button is-danger is-light" onclick="openDelete('password')">Delete with password</button>
        <button class="button is-danger is-light" onclick="openDelete('otp')">Delete with OTP</button>
      </div>

      <div id="delete-password" style="display:none;">
        <div class="password-wrapper">
          <input id="del_cur_pwd" class="input" type="password" placeholder="Current password">
          <span class="toggle-eye" data-target="del_cur_pwd"><i class="fas fa-eye"></i></span>
        </div>
        <button class="button is-danger mt-2" onclick="doDelete('password')">Confirm Delete</button>
        <p id="del_msg_pw" class="help"></p>
      </div>

      <div id="delete-otp" style="display:none;">
        <button class="button is-danger is-light" onclick="startPwdOtp()">Send OTP codes</button>
        <input id="del_email_code" class="input mt-2" type="text" maxlength="6" placeholder="Email code">
        <input id="del_phone_code" class="input mt-2" type="text" maxlength="6" placeholder="Phone code">
        <button class="button is-danger mt-2" onclick="doDelete('otp')">Confirm Delete</button>
        <p id="del_msg_otp" class="help"></p>
      </div>
    </div>

  </div>
</section>

<script>
function openChange(which){ document.getElementById('change-'+which).style.display='block'; }
function togglePwdSection(id){
  document.getElementById('pwd-current').style.display='none';
  document.getElementById('pwd-otp').style.display='none';
  document.getElementById(id).style.display='block';
}

async function startChange(field){
  const v = document.getElementById('new_'+field).value.trim();
  const resp = await fetch("{% url 'start_contact_change' %}", {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"},
    body: new URLSearchParams({field, new_value: v})
  });
  const data = await resp.json();
  const el = document.getElementById(field+"_msg");
  el.className = "help " + (data.ok ? "is-success":"is-danger");
  el.textContent = data.ok ? "Code sent. Check your "+field+"." : (data.error || "Failed");
}

async function verifyChange(field){
  const code = document.getElementById(field+"_code").value.trim();
  const resp = await fetch("{% url 'verify_contact_change' %}", {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"},
    body: new URLSearchParams({field, code})
  });
  const data = await resp.json();
  const el = document.getElementById(field+"_msg");
  el.className = "help " + (data.ok ? "is-success":"is-danger");
  el.textContent = data.ok ? (field==="email"?"Email updated.":"Phone updated.") : (data.error || "Failed");
  if (data.ok) setTimeout(()=>location.reload(), 800);
}

async function savePwdCurrent(){
  const params = new URLSearchParams({
    current_password: document.getElementById('cur_pwd').value,
    new_password1: document.getElementById('new_pwd').value,
    new_password2: document.getElementById('new_pwd2').value,
  });
  const r = await fetch("{% url 'change_password_with_current' %}", {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}, body: params
  });
  const d = await r.json();
  const el = document.getElementById('pwd_current_msg');
  el.className = "help " + (d.ok ? "is-success":"is-danger");
  el.textContent = d.ok ? "Password updated." : (d.error || "Failed");
}

async function startPwdOtp(){
  await fetch("{% url 'start_password_change_otp' %}", {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}
  });
}

async function savePwdOtp(){
  const params = new URLSearchParams({
    email_code: document.getElementById('pwd_email_code').value,
    phone_code: document.getElementById('pwd_phone_code').value,
    new_password1: document.getElementById('otp_new_pwd').value,
    new_password2: document.getElementById('otp_new_pwd2').value,
  });
  const r = await fetch("{% url 'verify_password_change_otp' %}", {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}, body: params
  });
  const d = await r.json();
  const el = document.getElementById('pwd_otp_msg');
  el.className = "help " + (d.ok ? "is-success":"is-danger");
  el.textContent = d.ok ? "Password updated." : (d.error || "Failed");
}

function openDelete(which){
  document.getElementById('delete-password').style.display = (which==='password')?'block':'none';
  document.getElementById('delete-otp').style.display = (which==='otp')?'block':'none';
}

async function doDelete(mode){
  const params = new URLSearchParams({mode});
  if (mode==='password'){
    params.append('current_password', document.getElementById('del_cur_pwd').value);
  } else {
    params.append('email_code', document.getElementById('del_email_code').value);
    params.append('phone_code', document.getElementById('del_phone_code').value);
  }
  const r = await fetch("{% url 'delete_account' %}", {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}, body: params
  });
  const d = await r.json();
  const el = document.getElementById(mode==='password'?'del_msg_pw':'del_msg_otp');
  if (d.ok){
    el.className = "help is-success";
    el.textContent = "Account deleted. Goodbye!";
    setTimeout(()=>{ window.location = "{% url 'login' %}"; }, 800);
  }else{
    el.className = "help is-danger";
    el.textContent = d.error || "Failed";
  }
}
</script>
{% endblock %}
