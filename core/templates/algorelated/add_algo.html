# -*- coding: utf-8 -*-
"""
Created on Tue Aug  5 23:18:49 2025

@author: Home
"""

<!-- Simplified add_algo.html Template with Single Flat Condition Structure -->
{% extends 'core/base.html' %}
{% load static %}


{% block content %}

 
  
  <!-- jQuery (Only Once) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- jQuery UI (for drag/drop) -->
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<body>

<section class="section">
  <div class="container">
    <h1 class="title">Add New Algorithm</h1>

    
<form id="algoForm" method="post" action="{% url 'add_algo' %}">
{% csrf_token %}
  <!-- SECTION 1 -->
  <div id="basicDetailsSection">
    <div class="field">
      <label class="label">Algorithm Name <span class="has-text-danger">*</span></label>
      <input class="input" type="text" name="AlgoName" id="AlgoName"
       value="{{ algo.algo_name|default:'' }}" required>
      <p class="help is-danger" id="algoNameError" role="alert" style="display: none;">Algorithm name is required.</p>
    </div>

    <div class="field">
      <label class="label">Minimum Fund Required <span class="has-text-danger">*</span></label>
      <input class="input" type="number" name="Minimum_Fund_Reqd" id="MinimumFund"
       value="{{ algo.minimum_fund_reqd|default:'' }}" required>
      <p class="help is-danger" id="fundError" role="alert" style="display: none;">Minimum fund is required.</p>
    </div>

    <div class="field">
      <label class="label">Description</label>
      <textarea class="textarea" name="Algo_description" id="Algo_description">{{ algo.algo_description|default:'' }}</textarea>
    </div>

    <div class="field mt-4">
      <button type="button" class="button is-primary" id="defineStrategyBtn" disabled onclick="showStrategySection()">üöÄ Define Strategy</button>
    </div>
  </div>

  <!-- SECTION 2: Initially Hidden -->
  <div id="strategySection" style="display: none;">
    <hr>

    <div class="field">
      <label class="label">Define Variables (User-Defined Variables)</label>
      <div id="userConstantsContainer"></div>
      <button type="button" class="button is-small is-info mt-2" onclick="addUserDefinedVariable()">‚ûï Add Variable</button>
    </div>

    <hr>
    <div id="legsContainer"></div>

    <div class="field mt-4">
      <button type="button" class="button is-primary" onclick="addLeg()">‚ûï Add Leg</button>
    </div>

    <div class="field mt-4">
      <button type="button" class="button is-info" onclick="showPreview()">üëÅÔ∏è Preview</button>
      <button type="submit" class="button is-success ml-2">‚úÖ Confirm & Submit</button>
    </div>
  </div>
</form>

<p id="const_preview_${index}" class="is-size-7 has-text-grey mt-1 ml-1"></p>

<div class="box mt-5" id="jsonPreviewBox" style="display:none">
  <h2 class="subtitle">üßæ JSON Preview</h2>
  <pre><code id="jsonPreview"></code></pre>
  <h2 class="subtitle mt-3">üêç Python Preview</h2>
  <pre><code id="pythonPreview"></code></pre>
</div>


<script>
// 1) Expose the raw JSON directly to JS variables (no parsing needed in utils.js)
//window.instruments  = {{ instruments_json|safe }};
window.segments = {{ segments|safe }};  // e.g., ["NFO","NSE","BSE","MCX"]
window.instrumentsBySegment = {{ instruments_by_segment_json|safe }};
window.indicators   = {{ indicators_json|safe }};
window.all_symbols  = {{ symbol_list_json|safe }};
window.userDefinedVariables = [];   // add page starts empty
window.legs = [];                   // add page starts empty
window.isEditMode = false;
window.userVars = {{ user_vars_json|safe }};
window.symbolList = {{ symbol_list_json|safe }};
</script>
{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof initAlgoFormValidation !== 'function') {
      console.error('initAlgoFormValidation not loaded');
      return;
    }
    // Add Algo:
    // initAlgoFormValidation({ gateBtnId: 'defineStrategyBtn', excludeId: null });
    // Edit Algo:
    // initAlgoFormValidation({ gateBtnId: null, excludeId: {{ algo.id }} });

    initAlgoFormValidation({
      gateBtnId: 'defineStrategyBtn',   // null on edit page
      excludeId: null,                  // set to {{ algo.id }} on edit page
      endpoint: '/check_algo_name/'
    });
  });
</script>
{% endblock %}



<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/expression.js' %}"></script>
<script>
  // if backend didn't set it, ensure it exists to avoid undefined errors
  window.userDefinedVariables = Array.isArray(window.userDefinedVariables) ? window.userDefinedVariables : [];
</script>
<script src="{% static 'js/condition.js' %}"></script>
<script src="{% static 'js/preview.js' %}"></script>
<script src="{% static 'js/init.js' %}"></script>


{% endblock %}

