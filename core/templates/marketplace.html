{% extends 'core/base.html' %}
{% load static %}
{% block content %}
  <title>Marketplace</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
  <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      referrerpolicy="no-referrer">
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .k-card{ border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow); }
    .k-planpill{ border:1px dashed var(--line); border-radius:999px; padding:.2rem .6rem; font-size:.85rem; background:var(--soft); }
    .k-aside{ position: sticky; top: 64px; }
  </style>

<section class="section">
  <div class="container">
    <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
      <h1 class="title">Marketplace</h1>
      <div>
       + <a class="button is-light" href="{% url 'dashboard' %}">Back to Dashboard</a>
      </div>
    </div>

    <div class="field has-addons mb-5">
      <p class="control is-expanded">
        <input class="input" id="marketSearch" placeholder="Search offers…">
      </p>
      <p class="control"><button class="button is-primary" id="btnMarketReload">Search</button></p>
    </div>

    <div class="columns">
      <!-- Grid -->
      <div class="column is-8">
        <div id="offerGrid" class="columns is-multiline"></div>
        <div id="offerEmpty" class="notification is-light is-hidden">No offers found.</div>
      </div>

      <!-- Performance aside -->
      <div class="column is-4">
        <div class="box k-aside">
          <h3 class="title is-6" id="perfTitle">Performance</h3>
          <canvas id="offerChart" height="140"></canvas>
          <div class="columns is-mobile mt-3">
            <div class="column">
              <p class="is-size-7 has-text-grey">Sharpe</p>
              <p class="is-size-5" id="oSharpe">—</p>
            </div>
            <div class="column">
              <p class="is-size-7 has-text-grey">Max DD</p>
              <p class="is-size-5" id="oMdd">—</p>
            </div>
            <div class="column">
              <p class="is-size-7 has-text-grey">Win%</p>
              <p class="is-size-5" id="oWin">—</p>
            </div>
            <div class="column">
              <p class="is-size-7 has-text-grey">CAGR</p>
              <p class="is-size-5" id="oCagr">—</p>
            </div>
          </div>
          <p class="is-size-7 has-text-grey mt-2" id="oNote">Select an offer to preview its last-30D stats.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Invite Modal -->
<div class="modal" id="inviteModal">
  <div class="modal-background"></div>
  <div class="modal-card" style="width:560px;">
    <header class="modal-card-head">
      <p class="modal-card-title">Invite to Offer</p>
      <button class="delete" aria-label="close" data-close="#inviteModal"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">Invitee Email</label>
        <input class="input" id="inviteEmail" placeholder="user@example.com">
      </div>
      <div class="field">
        <label class="label">Plan</label>
        <div class="select is-fullwidth"><select id="invitePlan"></select></div>
      </div>
      <div class="field is-horizontal">
        <div class="field-body">
          <div class="field"><label class="label">Discount (minor)</label><input class="input" id="inviteDiscount" placeholder="5000 = ₹50"></div>
          <div class="field"><label class="label">Trial (days)</label><input class="input" id="inviteTrial" placeholder="7"></div>
        </div>
      </div>
      <div class="field"><label class="label">Message</label><textarea class="textarea" id="inviteMsg" maxlength="280"></textarea></div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-primary" id="inviteSend">Send Invite</button>
      <button class="button" data-close="#inviteModal">Close</button>
    </footer>
  </div>
</div>

<!-- Subscribe Modal -->
<div class="modal" id="subscribeModal">
  <div class="modal-background"></div>
  <div class="modal-card" style="width:560px;">
    <header class="modal-card-head">
      <p class="modal-card-title">Subscribe</p>
      <button class="delete" aria-label="close" data-close="#subscribeModal"></button>
    </header>
    <section class="modal-card-body">
      <div id="subOfferTitle" class="mb-2 has-text-weight-semibold"></div>
      <div class="field"><label class="label">Plan</label><div class="select is-fullwidth"><select id="subPlan"></select></div></div>
      <div class="field is-horizontal">
        <div class="field-body">
          <div class="field"><label class="label">Provider</label>
            <div class="select is-fullwidth"><select id="subProvider"><option value="razorpay">Razorpay</option><option value="stripe">Stripe</option></select></div>
          </div>
          <div class="field"><label class="label">Discount (minor)</label><input class="input" id="subDiscount" value="0"></div>
        </div>
      </div>
      <p class="is-size-7 has-text-grey">The correct split will be computed on the webhook.</p>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-primary" id="subStart">Continue</button>
      <button class="button" data-close="#subscribeModal">Close</button>
    </footer>
  </div>
</div>

<script>
(function(){
  let OFFERS=[]; let SELECTED=null; let chart=null; let INVITE_CTX={offerId:null, plans:[]}; let SUB_CTX={offerId:null, plans:[]};

  const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=(n)=> n==null?'—':Number(n).toLocaleString();
  function toast(msg,type='is-info'){ const n=document.createElement('div'); n.className=`notification ${type}`; n.style.position='fixed'; n.style.right='16px'; n.style.bottom='16px'; n.style.zIndex=1000; n.textContent=msg; document.body.appendChild(n); setTimeout(()=>n.remove(),2400); }

  function loadOffers(q=''){
    $('#offerGrid').innerHTML = '';
    fetch(`/market/offers/?q=${encodeURIComponent(q)}`).then(r=>r.json()).then(d=>{
      if(!d.success) throw 0; OFFERS=d.offers||[]; renderOffers();
    }).catch(_=>toast('Failed to load offers','is-danger'));
  }

  function renderOffers(){
    const grid = $('#offerGrid'); grid.innerHTML='';
    const q = ($('#marketSearch').value||'').toLowerCase();
    const list = OFFERS.filter(o=>!q||String(o.title||'').toLowerCase().includes(q));
    if(!list.length){ $('#offerEmpty').classList.remove('is-hidden'); } else $('#offerEmpty').classList.add('is-hidden');

    list.forEach(o=>{
      const col=document.createElement('div'); col.className='column is-half';
      const planBadges=(o.plans||[]).map(p=>`<span class="k-planpill">${p.name} • ${p.period} • ${(p.currency||'').toUpperCase()} ${(p.price_minor/100).toFixed(2)}</span>`).join(' ');
      col.innerHTML=`
        <div class="card k-card" data-offer="${o.id}">
          <header class="card-header">
            <p class="card-header-title">${o.title}</p>
            <div class="card-header-icon">
              <div class="buttons">
                <button class="button is-light" data-invite="${o.id}">Invite</button>
                <button class="button is-primary" data-subscribe="${o.id}">Subscribe</button>
              </div>
            </div>
          </header>
          <div class="card-content">
            <p class="has-text-grey">${o.tagline||''}</p>
            <div class="mt-2">${planBadges||'<span class="tag">No plans</span>'}</div>
          </div>
        </div>`;
      // clicking anywhere on card loads perf to aside
      col.querySelector('.card').addEventListener('click', (e)=>{
        if(e.target.closest('.buttons')) return; // ignore when clicking buttons
        SELECTED = o.id; loadOfferDetail(o.id);
      });
      grid.appendChild(col);
    });
  }

  function loadOfferDetail(id){
    fetch(`/market/offer/${id}/`).then(r=>r.json()).then(d=>{
      if(!d.success) return;
      const o=d.offer; $('#perfTitle').textContent=o.title;
      // preview_stats example expected shape:
      // { sharpe:1.3, mdd:-0.12, win_rate:0.58, cagr:0.24, series:[{date:'YYYY-MM-DD', pnl:123}, ...] }
      const s=o.preview_stats||{};
      $('#oSharpe').textContent = s.sharpe!=null?Number(s.sharpe).toFixed(2):'—';
      $('#oMdd').textContent    = s.mdd!=null?(Number(s.mdd)*100).toFixed(1)+'%':'—';
      $('#oWin').textContent    = s.win_rate!=null?(Number(s.win_rate)*100).toFixed(1)+'%':'—';
      $('#oCagr').textContent   = s.cagr!=null?(Number(s.cagr)*100).toFixed(1)+'%':'—';
      $('#oNote').textContent   = s.series && s.series.length ? 'Last 30 days cumulative PnL' : 'No recent performance available';

      // chart
      if(chart){ chart.destroy(); chart=null; }
      const labels = (s.series||[]).map(x=>x.date);
      const equity = (s.series||[]).reduce((acc,x)=>{ acc.push((acc.at(-1)||0)+Number(x.pnl||0)); return acc; },[]);
      const ctx=$('#offerChart').getContext('2d');
      chart=new Chart(ctx,{ type:'line', data:{labels, datasets:[{data:equity, tension:.25}]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}}} });

      // preload plans for modals
      INVITE_CTX.offerId = o.id; INVITE_CTX.plans = o.plans||[];
      SUB_CTX.offerId = o.id; SUB_CTX.plans = o.plans||[];
    });
  }

  // Buttons across page (delegated)
  document.addEventListener('click',(e)=>{
    const t=e.target;

    // search
    if(t.id==='btnMarketReload'){ loadOffers($('#marketSearch').value||''); }

    // open invite
    if(t.dataset.invite){
      const offerId=Number(t.dataset.invite);
      fetch(`/market/offer/${offerId}/`).then(r=>r.json()).then(d=>{
        if(!d.success) return toast('Failed','is-danger');
        INVITE_CTX.offerId = offerId; INVITE_CTX.plans = d.offer.plans||[];
        const sel=$('#invitePlan'); sel.innerHTML = INVITE_CTX.plans.map(p=>`<option value="${p.id}">${p.name} • ${p.period} • ${(p.currency||'').toUpperCase()} ${(p.price_minor/100).toFixed(2)}</option>`).join('');
        $('#inviteEmail').value=''; $('#inviteDiscount').value=''; $('#inviteTrial').value=d.offer.default_trial_days||''; $('#inviteMsg').value='';
        $('#inviteModal').classList.add('is-active');
      });
    }

    // send invite
    if(t.id==='inviteSend'){
      const email=$('#inviteEmail').value.trim(); const planId=Number($('#invitePlan').value);
      const discount=parseInt($('#inviteDiscount').value||'0',10)||0; const trial=parseInt($('#inviteTrial').value||'0',10)||null;
      fetch(`/market/offer/${INVITE_CTX.offerId}/invite/`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ invitee_email:email, plan_id:planId, discount_type: discount>0?'amount':'none', discount_val:discount, trial_days:trial })
      }).then(r=>r.json()).then(d=>{
        if(d.success){ toast('Invite sent'); $('#inviteModal').classList.remove('is-active'); } else toast(d.error||'Invite failed','is-danger');
      });
    }

    // subscribe (free → activate; paid → checkout)
    if(t.dataset.subscribe){
      const offerId=Number(t.dataset.subscribe);
      fetch(`/market/offer/${offerId}/`).then(r=>r.json()).then(d=>{
        if(!d.success) return toast('Failed','is-danger');
        SUB_CTX.offerId = offerId; SUB_CTX.plans = d.offer.plans||[];
        $('#subOfferTitle').textContent=d.offer.title;
        $('#subPlan').innerHTML = SUB_CTX.plans.map(p=>`<option value="${p.id}">${p.name} • ${p.period} • ${(p.currency||'').toUpperCase()} ${(p.price_minor/100).toFixed(2)}</option>`).join('');
        $('#subDiscount').value='0';
        $('#subscribeModal').classList.add('is-active');
      });
    }

    if(t.id==='subStart'){
      const planId=Number($('#subPlan').value); const provider=$('#subProvider').value;
      const plan=(SUB_CTX.plans||[]).find(p=>p.id===planId); const discount=parseInt($('#subDiscount').value||'0',10)||0;
      if(!plan) return toast('Select a plan','is-danger');

      if(plan.price_minor===0){
        fetch('/market/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({offer_id:SUB_CTX.offerId, plan_id:planId})})
          .then(r=>r.json()).then(d=>{
            if(d.success && d.activated){ toast('Activated'); $('#subscribeModal').classList.remove('is-active'); }
            else if(d.checkout_url){ window.location.href=d.checkout_url; }
            else { toast('Subscribe failed','is-danger'); }
          });
        return;
      }
      fetch('/checkout/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({offer_id:SUB_CTX.offerId, plan_id:planId, provider, discount_minor:discount})})
        .then(r=>r.json()).then(d=>{
          if(!d.success) return toast(d.error||'Checkout failed','is-danger');
          if(d.provider==='stripe' && d.checkout_url){ window.location = d.checkout_url; }
          if(d.provider==='razorpay'){ if(d.short_url) window.open(d.short_url,'_blank'); toast('Razorpay subscription created'); }
          $('#subscribeModal').classList.remove('is-active');
        });
    }

    if(t.matches('[data-close]')){ const sel=t.getAttribute('data-close'); if(sel) document.querySelector(sel).classList.remove('is-active'); }
  });

  // close modals by background
  $$('.modal .modal-background').forEach(bg=>bg.addEventListener('click',()=>bg.closest('.modal').classList.remove('is-active')));

  // init
  loadOffers('');
  // pick first to show perf (optional)
  setTimeout(()=>{ const first = OFFERS[0]; if(first){ loadOfferDetail(first.id); }}, 800);
})();
</script>
{% endblock %}